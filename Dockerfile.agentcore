# syntax=docker/dockerfile:1

# Build stage
FROM golang:1.25-bookworm AS builder

ARG VERSION=dev

WORKDIR /build

# Clone PromptKit sibling (needed for replace directives in go.mod)
RUN git clone --depth 1 https://github.com/AltairaLabs/PromptKit.git /build/promptkit

# Copy module files first for layer caching
COPY go.mod go.sum ./

# Rewrite replace directives to point to /build/promptkit
RUN sed -i 's|=> ../promptkit/|=> /build/promptkit/|g' go.mod

RUN go mod download

# Copy source (go.mod gets overwritten, so rewrite again)
COPY . .
RUN sed -i 's|=> ../promptkit/|=> /build/promptkit/|g' go.mod

# Build static binary
RUN CGO_ENABLED=0 GOWORK=off GOOS=linux go build \
    -ldflags="-s -w -X main.version=${VERSION}" \
    -o /agentcore-runtime \
    ./cmd/agentcore-runtime/

# Runtime stage
FROM gcr.io/distroless/static-debian12

COPY --from=builder /agentcore-runtime /agentcore-runtime

EXPOSE 9000

ENTRYPOINT ["/agentcore-runtime"]
