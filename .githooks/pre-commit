#!/usr/bin/env bash
set -euo pipefail

# Only run checks if Go files are staged
STAGED_GO=$(git diff --cached --name-only --diff-filter=ACM -- '*.go' || true)
if [ -z "$STAGED_GO" ]; then
    exit 0
fi

echo "==> Running goimports..."
UNFORMATTED=$(GOWORK=off goimports -l -local github.com/AltairaLabs/promptarena-deploy-agentcore $STAGED_GO)
if [ -n "$UNFORMATTED" ]; then
    echo "ERROR: Files need formatting (run 'make fmt'):"
    echo "$UNFORMATTED"
    exit 1
fi

echo "==> Running golangci-lint..."
GOWORK=off golangci-lint run ./...

echo "==> Running tests..."
GOWORK=off go test ./... -race -count=1

echo "==> Building..."
GOWORK=off go build -o /dev/null .

echo "All checks passed."
